/*
 * pedal_hw.c
 *
 *  Created on: 24/04/2022
 *      Author: Juan
 */

/***********************************************************************************************************************
 * Included files
 **********************************************************************************************************************/

#include "pedal_hw.h"

/***********************************************************************************************************************
 * Macros
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * Private variables definitions
 **********************************************************************************************************************/

/* Buffer lectura ADC DMA */
uint16_t adc_buf[ADC_BUF_LEN];

/** Bandera conversi√≥n ADC */
adc_conv_status_t flag_adc = ADC_CONV_NOT_COMPLETED;

/***********************************************************************************************************************
 * Private functions prototypes
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * Public functions implementation
 **********************************************************************************************************************/

void PEDAL_HW_Init(void)
{
	/* Initialize DMA */
	MX_DMA_Init();

	/* Initialize ADC1 */
	MX_ADC1_Init();

	/* Initialize time base timer for ADC triggering */
	MX_TIM2_Init();

	/* Start ADC with DMA */
	HAL_ADC_Start_DMA(&hadc1, (uint32_t*)adc_buf, ADC_BUF_LEN);

	/* Start time base trigger ADC timer */
	HAL_TIM_Base_Start(&htim2);
}

/***********************************************************************************************************************
 * Exported functions implementation
 **********************************************************************************************************************/

/* Called when buffer is completely filled */
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc)
{
	/* Turn on LED 3 (yellow LED) */
	BSP_LED_Toggle(LED3);

	/* Start ADC DMA again */
	HAL_ADC_Start_DMA(hadc, (uint32_t*)adc_buf, ADC_BUF_LEN);

	/* The flag indicates that the callback was called */
	flag_adc = ADC_CONV_COMPLETED;
}

/***********************************************************************************************************************
 * Private functions implementation
 **********************************************************************************************************************/

